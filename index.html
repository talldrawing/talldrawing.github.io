<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Joseph Villaflor-Medina · Notes & Experiments</title>
  <meta name="description" content="Interactive page: JP word/grammar of the day, public Core 2K/6K stats, and a communal chalkboard (chalk.png).">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1220; --panel:#111827; --line:#1f2937; --text:#e5e7eb; --muted:#a3a3a3; --accent:#60a5fa; --accent2:#a78bfa; --r:16px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f7fb; --panel:#ffffff; --line:#e5e7eb; --text:#0b1220; --muted:#556; --shadow:0 8px 20px rgba(2,6,23,.08); } }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.65;background:radial-gradient(1400px 600px at 50% -10%, #172554, var(--bg));color:var(--text)}
    .wrap{max-width:1040px;margin:0 auto;padding:28px 18px 60px}
    .nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:inherit}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow)}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:999px;text-decoration:none;color:inherit;cursor:pointer;background:transparent}
    .btn:hover{background:rgba(255,255,255,.06)}
    .hero{background:linear-gradient(180deg,rgba(96,165,250,.18),rgba(167,139,250,.12));border:1px solid var(--line);border-radius:20px;padding:28px;text-align:center;box-shadow:var(--shadow)}
    h1{margin:6px 0 8px;font-size:clamp(28px,5vw,40px)}
    .tag{color:var(--muted);margin:0}
    .grid{display:grid;gap:18px;margin-top:20px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{background:transparent;border:1px solid var(--line);border-radius:10px;padding:8px 10px;color:inherit}
    .progress{height:10px;background:#0b223b;border-radius:999px}
    .bar{width:0;height:10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    canvas{background:#0a0a0a;border:1px solid var(--line);border-radius:12px;touch-action:none;width:100%;height:420px}
    .note{border-left:3px solid var(--accent); padding:8px 12px; background:rgba(96,165,250,.08); border-radius:8px}
    .hidden{display:none}
    img.chalk{width:100%; height:auto; border-radius:12px; border:1px solid var(--line)}
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <a class="brand" href="#"><div class="logo">JV</div><strong>talldrawing.github.io</strong></a>
      <div class="row">
        <a class="btn" href="#jp">日本語</a>
        <a class="btn" href="#anki">Progress</a>
        <a class="btn" href="#board">Chalkboard</a>
        <a class="btn" href="#connect">Connect</a>
      </div>
    </nav>

    <header class="hero">
      <h1><span style="background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent">Joseph Villaflor-Medina</span></h1>
      <p class="tag">Tech sales in progress · curious about dev tools · 日本語：N1への道 · gym rat</p>
    </header>

    <!-- Japanese: Word & Grammar of the Day -->
    <section class="card" id="jp">
      <h2>Japanese — Word & Grammar of the Day</h2>
      <p class="muted small">Rotates daily from a local list (no backend). Edit lists in the code anytime.</p>
      <div id="jpWord"></div>
      <div id="jpGrammar" style="margin-top:10px"></div>
      <div class="small muted" style="margin-top:6px">Seed: <span id="seed"></span></div>
    </section>

    <div class="grid">
      <!-- Core 2K/6K Progress (Public via progress.json; fallback to local) -->
      <section class="card" id="anki">
        <h2>Study Progress (Core 2K/6K)</h2>
        <p class="muted small" id="progMode">Loading…</p>

        <div class="row" id="inputsRow">
          <label>Reviews today</label>
          <input class="input" type="number" id="reviews" min="0" style="width:110px"/>
          <label>New cards today</label>
          <input class="input" type="number" id="new" min="0" style="width:110px"/>
          <label>Streak (days)</label>
          <input class="input" type="number" id="streak" min="0" style="width:110px"/>
          <button class="btn" id="saveProg">Save</button>
          <button class="btn" id="markStudied">Mark studied today</button>
        </div>

        <div style="margin-top:14px" class="row">
          <label>Total learned</label>
          <input class="input" type="number" id="learned" min="0" style="width:120px"/>
          <label>Mature</label>
          <input class="input" type="number" id="mature" min="0" style="width:120px"/>
          <label>Deck size</label>
          <input class="input" type="number" id="deckSize" min="1" value="6000" style="width:120px"/>
        </div>

        <div style="margin-top:12px">
          <div class="muted small">Daily Reviews Goal</div>
          <div class="progress"><div id="progBarDaily" class="bar"></div></div>
          <div class="row small muted"><span id="progTextDaily"></span></div>
        </div>

        <div style="margin-top:14px">
          <div class="muted small">Overall Learned Progress</div>
          <div class="progress"><div id="progBarLearned" class="bar"></div></div>
          <div class="row small muted"><span id="progTextLearned"></span></div>
        </div>

        <div class="row small" id="importExportRow" style="margin-top:10px">
          <button class="btn" id="exportProg">Export JSON</button>
          <label for="importFile" class="btn">Import JSON</label>
          <input id="importFile" type="file" accept="application/json" style="display:none"/>
        </div>
      </section>

      <!-- Communal Chalkboard -->
      <section class="card" id="board">
        <h2>Digital Chalkboard</h2>
        <p class="note small" id="boardNote">
          Communal board: anyone can draw and <b>Publish to Board</b>. The image below is the current shared <code>chalk.png</code>.
        </p>

        <!-- Public image -->
        <img id="chalkPublic" class="chalk" src="./chalk.png" alt="Chalkboard image (public)"
             onerror="this.classList.add('hidden');document.getElementById('noChalk').classList.remove('hidden');" />
        <p class="muted small hidden" id="noChalk">No <code>chalk.png</code> yet. Click <b>Start drawing</b> and publish to create it.</p>

        <!-- Edit toggle -->
        <div class="toolbar" id="editRow">
          <button class="btn" id="startEditBtn" type="button">Start drawing</button>
          <button class="btn hidden" id="cancelEditBtn" type="button">Cancel</button>
        </div>

        <!-- Drawing tools (hidden until editing) -->
        <div class="toolbar hidden" id="toolbar">
          <label>Tool:</label>
          <button class="btn" id="penBtn" type="button">Pen</button>
          <button class="btn" id="eraserBtn" type="button">Eraser</button>
          <label>Size:</label>
          <input type="range" id="size" min="2" max="24" value="6"/>
          <button class="btn" id="clear" type="button">Clear</button>
          <button class="btn" id="saveImg" type="button">Download PNG</button>
        </div>

        <canvas id="chalk" class="hidden" width="800" height="420"></canvas>
        <p class="muted small hidden" id="editHint">
          Editing mode: starts with the latest board. Draw below, then click <b>Publish to Board</b>.
        </p>

        <!-- Publish (shown in edit mode) -->
        <div class="toolbar hidden" id="publishRow">
          <button class="btn" id="publishBtn" type="button">Publish to Board</button>
          <span style="opacity:.6;margin-left:8px;">Anyone can overwrite the image</span>
        </div>
      </section>
    </div>

    <!-- Connect -->
    <section class="card" id="connect" style="margin-top:18px">
      <h2>Connect</h2>
      <ul>
        <li><a href="mailto:josephevm415@gmail.com">Email</a></li>
        <li><a href="https://www.linkedin.com/in/jvm415" target="_blank" rel="noopener">LinkedIn</a></li>
        <li><a href="https://github.com/talldrawing" target="_blank" rel="noopener">GitHub</a></li>
      </ul>
    </section>

    <footer class="muted" style="text-align:center;margin-top:22px">© <span id="y"></span> Joseph Villaflor-Medina — Built on GitHub Pages</footer>
  </div>

  <script>
    // --- Owner flag still supported: ?owner=1 auto-enters edit mode
    const params = new URLSearchParams(location.search);
    const OWNER_MODE = params.get('owner') === '1';

    // --- JP Word & Grammar of the Day ---
    const words = [
      {jp:'挑戦 (ちょうせん)', en:'challenge; try; attempt', ex:'新しい挑戦をする。'},
      {jp:'習慣 (しゅうかん)', en:'habit; custom', ex:'毎日の習慣を守る。'},
      {jp:'効率 (こうりつ)', en:'efficiency', ex:'効率よく勉強する。'},
      {jp:'縁 (えん)', en:'fate; connection', ex:'日本との縁を感じる。'},
      {jp:'進捗 (しんちょく)', en:'progress', ex:'進捗どうですか。'}
    ];
    const grammar = [
      {pt:'〜ようにする', en:'make an effort to / try to', ex:'毎日日本語を勉強するようにしている。'},
      {pt:'〜てみる', en:'try doing (as an experiment)', ex:'新しい方法を試してみる。'},
      {pt:'〜ことにする', en:'decide to do', ex:'毎朝10分間、単語を復習することにした。'},
      {pt:'〜わけではない', en:"doesn't mean that...", ex:'忙しいわけではないが、予定がある。'},
      {pt:'〜っぱなし', en:'leave something in a state', ex:'電気をつけっぱなしにしないで。'}
    ];
    function daySeed(){ const d = new Date(); return Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())/86400000); }
    function pick(list){ return list[ daySeed() % list.length ]; }
    const w = pick(words); const g = pick(grammar);
    document.getElementById('jpWord').innerHTML = `<strong>Word:</strong> ${w.jp} — ${w.en}<br><span class="muted">例: ${w.ex}</span>`;
    document.getElementById('jpGrammar').innerHTML = `<strong>Grammar:</strong> ${g.pt} — ${g.en}<br><span class="muted">例: ${g.ex}</span>`;
    document.getElementById('seed').textContent = daySeed();

    // --- Study Progress (public via progress.json; fallback to localStorage) ---
    const GOAL_DEFAULT = 100;
    const reviews = document.getElementById('reviews');
    const news = document.getElementById('new');
    const streak = document.getElementById('streak');
    const learned = document.getElementById('learned');
    const mature = document.getElementById('mature');
    const deckSizeInput = document.getElementById('deckSize');
    const progBarDaily = document.getElementById('progBarDaily');
    const progTextDaily = document.getElementById('progTextDaily');
    const progBarLearned = document.getElementById('progBarLearned');
    const progTextLearned = document.getElementById('progTextLearned');
    const progMode = document.getElementById('progMode');
    const importExportRow = document.getElementById('importExportRow');
    const inputsRow = document.getElementById('inputsRow');

    function clampPct(n){ return Math.max(0, Math.min(100, Math.round(n))); }
    function updateBars(goal){
      const rev = Number(reviews?.value || 0);
      const pctDaily = clampPct((rev / (goal||GOAL_DEFAULT)) * 100);
      progBarDaily.style.width = pctDaily + '%';
      progTextDaily.textContent = `${rev}/${goal||GOAL_DEFAULT} reviews (${pctDaily}%) · New: ${Number(news?.value||0)} · Streak: ${Number(streak?.value||0)}d`;

      const learnedNum = Number(learned?.value || 0);
      const deck = Math.max(1, Number(deckSizeInput?.value || 6000));
      const pctLearned = clampPct((learnedNum / deck) * 100);
      progBarLearned.style.width = pctLearned + '%';
      progTextLearned.textContent = `${learnedNum}/${deck} learned (${pctLearned}%) · Mature: ${Number(mature?.value || 0)}`;
    }

    function loadLocal(){
      const data = JSON.parse(localStorage.getItem('jpProgress') || '{}');
      if (reviews) reviews.value = data.reviews ?? 0;
      if (news) news.value = data.new ?? 0;
      if (streak) streak.value = data.streak ?? 0;
      if (learned) learned.value = data.learned ?? 0;
      if (mature) mature.value = data.mature ?? 0;
      if (deckSizeInput) deckSizeInput.value = data.deckSize ?? 6000;
      updateBars(data.goal||GOAL_DEFAULT);
      progMode.textContent = 'Private to your browser (local mode)';
      importExportRow.classList.remove('hidden');
      inputsRow.classList.remove('hidden');
    }

    function saveLocal(){
      const data = {
        reviews: Number(reviews?.value || 0),
        new: Number(news?.value || 0),
        streak: Number(streak?.value || 0),
        learned: Number(learned?.value || 0),
        mature: Number(mature?.value || 0),
        deckSize: Number(deckSizeInput?.value || 6000),
        goal: GOAL_DEFAULT,
        lastSaved: new Date().toISOString()
      };
      localStorage.setItem('jpProgress', JSON.stringify(data));
      updateBars(data.goal);
    }

    async function tryLoadPublic(){
      try {
        const res = await fetch('./progress.json', {cache:'no-store'});
        if(!res.ok) throw new Error('no public progress');
        const p = await res.json();
        if (reviews) reviews.value = p.reviewsToday ?? 0;
        if (news) news.value = p.newToday ?? 0;
        if (streak) streak.value = p.streak ?? 0;
        if (learned) learned.value = p.learned ?? 0;
        if (mature) mature.value = p.mature ?? 0;
        if (deckSizeInput) deckSizeInput.value = p.deckSize ?? 6000;
        updateBars(p.goal||GOAL_DEFAULT);
        progMode.textContent = 'Public display (from progress.json)';
        for (const el of [reviews, news, streak, learned, mature, deckSizeInput]) { el?.setAttribute('disabled',''); el?.setAttribute('readonly',''); }
        importExportRow.classList.add('hidden');
        inputsRow.classList.add('hidden');
        return true;
      } catch(e){ return false; }
    }

    document.getElementById('saveProg')?.addEventListener('click', saveLocal);
    document.getElementById('markStudied')?.addEventListener('click', () => {
      const rev = Number(reviews?.value || 0);
      if (rev > 0) { if (streak) streak.value = Number(streak.value || 0) + 1; saveLocal(); }
      else { alert('Do at least 1 review to count today!'); }
    });
    for (const el of [reviews, news, streak, learned, mature, deckSizeInput]) el?.addEventListener('input', ()=>updateBars());
    (async function initProgress(){ const ok = await tryLoadPublic(); if(!ok){ loadLocal(); } })();

    // --- Communal Chalkboard ---
    const chalkImg = document.getElementById('chalkPublic');
    const noChalk = document.getElementById('noChalk');
    const toolbar = document.getElementById('toolbar');
    const canvas = document.getElementById('chalk');
    const editHint = document.getElementById('editHint');
    const boardNote = document.getElementById('boardNote');
    const startBtn = document.getElementById('startEditBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const publishRow = document.getElementById('publishRow');

    // bust cache for the <img> so viewers always see latest
    function bustImage() {
      const img = document.getElementById("chalkPublic");
      if (!img) return;
      const u = new URL(img.src, location.origin);
      u.searchParams.set("ts", Date.now());
      img.src = u.toString();
    }
    bustImage();

    // Initialize canvas & tools once
    let initialized = false;
    function initCanvasIfNeeded(){
      if (initialized) return;
      const ctx = canvas.getContext('2d');
      let drawing=false, lastX=0, lastY=0, size=document.getElementById('size').value, erase=false;

      function resizeForHiDPI(){
        const ratio = window.devicePixelRatio||1;
        const w = canvas.clientWidth, h = canvas.clientHeight;
        if(!w||!h) return;
        canvas.width = w*ratio; canvas.height = h*ratio;
        ctx.setTransform(ratio,0,0,ratio,0,0);
      }
      function start(x,y){ drawing=true; lastX=x; lastY=y; }
      function line(x,y){
        if(!drawing) return;
        ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.strokeStyle = erase? '#0a0a0a' : '#e5e7eb';
        ctx.lineWidth = size;
        ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
        lastX=x; lastY=y;
      }
      function end(){ drawing=false; }
      function pos(e){
        const r=canvas.getBoundingClientRect();
        if(e.touches){ return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top}; }
        return {x:e.clientX-r.left, y:e.clientY-r.top};
      }

      canvas.addEventListener('mousedown', e=> start(pos(e).x,pos(e).y));
      canvas.addEventListener('mousemove', e=> line(pos(e).x,pos(e).y));
      window.addEventListener('mouseup', end);
      canvas.addEventListener('touchstart', e=>{e.preventDefault(); const p=pos(e); start(p.x,p.y)});
      canvas.addEventListener('touchmove', e=>{e.preventDefault(); const p=pos(e); line(p.x,p.y)});
      canvas.addEventListener('touchend', end);

      document.getElementById('penBtn').onclick=()=>{erase=false};
      document.getElementById('eraserBtn').onclick=()=>{erase=true};
      document.getElementById('size').oninput=(e)=> size=e.target.value;
      document.getElementById('clear').onclick=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); };
      document.getElementById('saveImg').onclick=()=>{
        const url = canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=url; a.download='chalk.png'; a.click();
      };

      const ro = new ResizeObserver(resizeForHiDPI);
      ro.observe(canvas);
      window.addEventListener('load', resizeForHiDPI);

      initialized = true;
    }

    // Draw current chalk.png onto the canvas so edits continue from the latest
    function loadExistingChalk(ctx, canvas) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // safe for same-origin GitHub Pages
        img.src = "./chalk.png?ts=" + Date.now(); // cache-bust
        img.onload = () => {
          const ratio = window.devicePixelRatio || 1;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width / ratio, canvas.height / ratio);
          resolve();
        };
        img.onerror = () => resolve(); // no existing image yet is fine
      });
    }

    async function enterEdit(){
      chalkImg?.classList.add('hidden');
      noChalk?.classList.add('hidden');
      toolbar?.classList.remove('hidden');
      canvas?.classList.remove('hidden');
      editHint?.classList.remove('hidden');
      publishRow?.classList.remove('hidden');
      startBtn?.classList.add('hidden');
      cancelBtn?.classList.remove('hidden');
      boardNote.innerHTML = 'Editing mode (communal): draw below, then <b>Publish to Board</b>.';

      initCanvasIfNeeded();
      // Wait a tick to ensure ResizeObserver sets width/height, then draw the existing image
      await new Promise(r => requestAnimationFrame(r));
      const ctx = canvas.getContext('2d');
      await loadExistingChalk(ctx, canvas);
    }

    function exitEdit(){
      toolbar?.classList.add('hidden');
      canvas?.classList.add('hidden');
      editHint?.classList.add('hidden');
      publishRow?.classList.add('hidden');
      cancelBtn?.classList.add('hidden');
      startBtn?.classList.remove('hidden');
      chalkImg?.classList.remove('hidden');
      bustImage();
      boardNote.innerHTML = 'Communal board: anyone can draw and <b>Publish to Board</b>. The image below is the current shared <code>chalk.png</code>.';
    }

    document.getElementById('startEditBtn')?.addEventListener('click', enterEdit);
    document.getElementById('cancelEditBtn')?.addEventListener('click', exitEdit);
    if (OWNER_MODE) { enterEdit(); } // auto-open if ?owner=1

    // --- Publish-to-board (data URL = simple, no preflight) ---
    const PUBLISH_URL = "https://chalk-worker.joseph-55e.workers.dev/publish";
    document.getElementById("publishBtn")?.addEventListener("click", async () => {
      const dataUrl = canvas.toDataURL("image/png");
      const btn = document.getElementById("publishBtn");
      btn.disabled = true; btn.textContent = "Publishing…";
      try {
        const r = await fetch(PUBLISH_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: dataUrl
        });
        if (!r.ok) throw new Error(await r.text());
        bustImage();
        alert("Published!");
      } catch (e) {
        alert("Failed: " + (e?.message || e));
      } finally {
        btn.disabled = false; btn.textContent = "Publish to Board";
      }
    });

    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
